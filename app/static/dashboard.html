<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Game Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f6f9; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .chart-box { margin-top: 30px; }
    </style>
</head>
<body>
<div class="container">
    <h2>üìä B√°o C√°o Doanh Thu & ƒê·ªô Kh√≥ Level (Real-time)</h2>
    <div class="chart-box">
        <canvas id="myChart"></canvas>
    </div>
    <div class="chart-box" style="margin-top: 50px;">
        <h3>üèÜ Top Booster ƒê∆∞·ª£c S·ª≠ D·ª•ng Nhi·ªÅu Nh·∫•t</h3>
        <table border="1" cellpadding="10" cellspacing="0" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr style="background-color: #007bff; color: white;">
                    <th>X·∫øp h·∫°ng</th>
                    <th>T√™n V·∫≠t Ph·∫©m (Booster)</th>
                    <th>S·ªë l∆∞·ª£t d√πng</th>
                    <th>T·ª∑ l·ªá (%)</th>
                </tr>
            </thead>
            <tbody id="boosterTableBody">
                </tbody>
        </table>
    </div>
</div>
</div>
<script>

    async function loadBoosterStats() {
        try {
            const response = await fetch('/api/analytics/booster-stats');
            const json = await response.json();
            const list = json.data;
            
            const tbody = document.getElementById('boosterTableBody');
            tbody.innerHTML = ''; // X√≥a tr·∫Øng

            list.forEach(item => {
                const row = `<tr>
                    <td style="text-align: center;">#${item.rank}</td>
                    <td><strong>${item.name}</strong></td>
                    <td style="text-align: center;">${item.used}</td>
                    <td style="text-align: center;">${item.percent}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (err) {
            console.error("L·ªói load Booster:", err);
        }
    }

    async function loadDataAndDrawChart() {
        try {
            const response = await fetch('/api/analytics/level-stats');
            const json = await response.json();
            const data = json.data;

            const labels = data.map(item => item.level);
            const revenue = data.map(item => item.revenue);
            const failRate = data.map(item => item.fail_rate);

            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Doanh thu Coin (Tr·ª•c tr√°i)',
                            data: revenue,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'T·ª∑ l·ªá Fail % (Tr·ª•c ph·∫£i)',
                            data: failRate,
                            type: 'line',
                            borderColor: '#ff6384',
                            borderWidth: 3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    scales: {
                        y: { type: 'linear', display: true, position: 'left' },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        } catch (err) {
            console.error("L·ªói t·∫£i API:", err);
            alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu API. H√£y ch·∫Øc ch·∫Øn Server ƒëang ch·∫°y!");
        }
    }
    loadDataAndDrawChart();
    loadBoosterStats();
</script>
</body>
</html>