<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ETL Monitor System</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; background-color: #f4f4f9; }
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        h1 { color: #333; }
        .status-box { padding: 15px; margin: 20px 0; border-radius: 5px; font-weight: bold; }
        .SUCCESS { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .FAILED { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .RUNNING { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .UNKNOWN { background-color: #e2e3e5; color: #383d41; }
        button { padding: 15px 30px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="card">
    <h1>üì° H·ªÜ TH·ªêNG ETL MONITOR</h1>
    <p>Tr·∫°ng th√°i l·∫ßn ch·∫°y g·∫ßn nh·∫•t:</p>
    
    <div id="statusBox" class="status-box UNKNOWN">
        ƒêang t·∫£i d·ªØ li·ªáu...
    </div>
    
    <div id="timeInfo" style="margin-bottom: 20px; color: #666;">--/--/----</div>
    
    <button id="btnRun" onclick="triggerJob()">üöÄ CH·∫†Y TH·ª¶ C√îNG NGAY</button>
</div>

<script>
    async function loadStatus() {
        try {
            let res = await fetch('/api/monitor/status');
            let data = await res.json();
            
            let box = document.getElementById('statusBox');
            box.className = 'status-box ' + data.status;
            box.innerText = data.status === 'RUNNING' ? '‚è≥ ƒêANG CH·∫†Y... (' + data.message + ')' : 
                            data.status === 'SUCCESS' ? '‚úÖ TH√ÄNH C√îNG: ' + data.message : 
                            data.status === 'FAILED' ? '‚ùå TH·∫§T B·∫†I: ' + data.message : 'Ch∆∞a c√≥ d·ªØ li·ªáu';
            
            document.getElementById('timeInfo').innerText = 'C·∫≠p nh·∫≠t l√∫c: ' + (data.time || 'Ch∆∞a ch·∫°y');

            // N·∫øu ƒëang ch·∫°y th√¨ disable n√∫t b·∫•m v√† t·ª± refresh sau 2s
            if (data.status === 'RUNNING') {
                document.getElementById('btnRun').disabled = true;
                document.getElementById('btnRun').innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";
                setTimeout(loadStatus, 2000); 
            } else {
                document.getElementById('btnRun').disabled = false;
                document.getElementById('btnRun').innerText = "üöÄ CH·∫†Y TH·ª¶ C√îNG NGAY";
            }
        } catch (e) {
            console.log("L·ªói k·∫øt n·ªëi API");
        }
    }

    async function triggerJob() {
        if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ch·∫°y l·∫°i ETL Job kh√¥ng?")) return;
        
        document.getElementById('btnRun').disabled = true;
        document.getElementById('btnRun').innerText = "ƒêang g·ª≠i l·ªánh...";
        
        await fetch('/api/monitor/trigger', { method: 'POST' });
        
        alert("ƒê√£ g·ª≠i l·ªánh ch·∫°y! H·ªá th·ªëng s·∫Ω x·ª≠ l√Ω ng·∫ßm.");
        setTimeout(loadStatus, 1000); // Load l·∫°i tr·∫°ng th√°i ngay
    }

    // Load tr·∫°ng th√°i khi v√†o trang
    loadStatus();
    // T·ª± ƒë·ªông refresh m·ªói 10 gi√¢y
    setInterval(loadStatus, 10000);
</script>

</body>
</html>